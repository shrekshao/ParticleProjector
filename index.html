<!DOCTYPE html>
<html lang="en">
<head>
	<title>ParticleProjector</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
		body {
			background-color: #000000;
			margin: 0px;
			overflow: hidden;
		}

		a {
			color: #0078ff;
		}

		.dg {
			right: auto!important;
			left: 20px!important;
		}
	</style>


	<script src="js/lib/three.js"></script>
	<!--<script src="js/lib/three.min.js"></script>-->
	<script src="js/lib/dat.gui.min.js"></script>
	<script src="js/lib/OrbitControls.js"></script>
	<script src="js/lib/GeometryUtils.js"></script>
	<!--<script src="js/lib/ImageUtils.js"></script>-->
	<script src="js/lib/MTLLoader.js"></script>
	<script src="js/lib/OBJLoader.js"></script>	
	<script src="js/lib/GPUComputationRenderer.js"></script>	



	<script id="vs-raw-sim" type="x-shader/x-vertex">
		precision highp float;
		precision highp int;

		attribute vec3 position;
		attribute vec2 uv;

		varying vec2 vUV;

		void main()	
		{
			vUV = uv;
			gl_Position = vec4( position, 1.0 );
		}
	</script>

	<script id="fs-raw-sim" type="x-shader/x-fragment">
		precision highp float;
		precision highp int;

		uniform sampler2D tPrevPos;
		uniform sampler2D tCurrPos;
		uniform sampler2D tInitPos;	// pos given by init random points in model triangles

		uniform float uDeltaT;	// value given by fixed update (based on time, not frame)
		uniform float uTime;


		varying vec2 vUV;

		void main()	
		{
			vec3 prevPos = texture2D(tPrevPos, vUV).rgb;
			vec3 currPos = texture2D(tCurrPos, vUV).rgb;
			vec3 vel = (currPos - prevPos) / uDeltaT;
			vec3 acc = vec3(0.0);

			// simulation part
			vec3 initPos = texture2D(tInitPos, vUV).rgb;
			vec3 dir = currPos - initPos;
			float dist = length(dir);
			dir /= dist;
			// acc = 1.0 / ( dot(dir, dir) + 0.1 ) ;
			acc = dir * dist;



			// apply updates
			vel = K_VEL_DECAY * vel + acc * uDeltaT;
			currPos += vel * uDeltaT;

			// gl_FragColor = vec4(currPos, 1.0);
			// gl_FragColor = vec4(1.0);
			// gl_FragColor = vec4(prevPos, 1.0);
			// gl_FragColor = vec4(vUV, 0.0, 1.0);


			// vec3 initPos = texture2D(tInitPos, vUV).rgb;
			gl_FragColor = vec4(abs(initPos), 1.0);
		}
	</script>



	<script id="vs-particles" type="x-shader/x-vertex">
		#define PS_CAM_MAX_DIST 12.0
		
		uniform float uPointSize;

		uniform float uTime;

		varying vec3 vNormal;
		varying vec2 vUV;

		void main()
		{
			vec3 pos = position;    // temp
			// pos += 1.0 * vec3( 0.1 * cos(0.1 * (uTime + pos.y) ), 1.0 * sin(0.13 * uTime * pos.z), 0.1 * sin(0.01 * uTime * pos.x + 3.14) );		// temp
			// pos.x += 0.000000001 * sin(0.0);

			vec3 camToPos = pos - cameraPosition;
			float camDist = length(camToPos);

			vNormal = normalMatrix * normal;
			vUV = uv;

			gl_PointSize = max( uPointSize * PS_CAM_MAX_DIST / camDist, 1.0 );

			gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
		}
    </script>

	<script id="fs-particles" type="x-shader/x-fragment">
		#define M_PI    3.14159265358979323846264338327950
		#define M_2PI   6.28318530717958647692528676655900
		#define M_PI2   1.57079632679489661923132169163975

		// varying vec3 vColor;
		varying vec3 vNormal;
		varying vec2 vUV;

		// uniform float uTime;
		uniform float uAlpha;

		uniform sampler2D tDiffuse;

		void main() 
		{
			vec3 color = vec3(1.0, 0.0, 0.0);  // tmp
			// vec3 color = vNormal;
			// vec3 color = vec3(vUV, 0.5);
			// vec3 color = texture2D( tDiffuse, vUV ).rgb;

			// // cos ? (from nop)
			// vec2 tmpCoord = 0.5 * cos( M_2PI * gl_PointCoord + M_PI ) + 0.5;
			// float alpha = tmpCoord.x * tmpCoord.y;
			
			// dist
			float alpha = 1.0 - min ( 1.0, 2.0 * length(gl_PointCoord - vec2(0.5, 0.5)) );
			// // squared length
			// vec2 r = gl_PointCoord - vec2(0.5, 0.5);
			// float alpha = 1.0 - min ( 1.0, 4.0 * dot(r, r) ) ;
			if (alpha <= 0.0)
			{
				discard;
			}
			gl_FragColor = vec4( color, uAlpha * alpha );


			// // stonebird fast solution, doesn't work on wallpapaer engine, wired
			// vec2 cxy = 2.0 * gl_PointCoord - 1.0;
			// float r = dot(cxy, cxy);
			// if (r > 1.0) {
			// 	discard;
			// }
			// float falloff = pow(r-1.0, 12.0);
			// // dist
			// float alpha = falloff;

			// if (alpha <= 0.0)
			// {
			// 	discard;
			// }
			// falloff *= 3.0;

			// gl_FragColor = vec4( color * vec3(falloff, falloff, falloff), uAlpha * alpha );
		}
    </script>



	<!--<script src="js/App.js"></script>-->
	<script src="js/Simulation.js"></script>
</head>

<body>
	<div style="position: absolute; top: 10px; width: 100%; text-align: center; color:#eee">
		Particle Projector</div>

	<script src="js/index.js"></script>
</body>

</html>
